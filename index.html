<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Axelrod</title>
    <style>
        html, body {
            padding: 0px;
            margin: 0px;
            width: 100%;
            height: 100%;
            font-family: Helvetica, Arial, sans-serif;
            font-size: 1.0em;
        }

        #description {
            width: 100%;
        }

        #content {
            width: 100%;
            height: 100%;
        }

        #vis {
            height: 90%;
            width: 100%;
        }

        #choice {
            margin-left: 50px;
            margin-top: 50px; 
            width: 100%;
        }

        .axis path,
        .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
        }

        @media(min-width: 600px) {
            #description {
                float: left;
                width: 29%;
                height: 100%;
            }

            #content {
                float: right;
                width: 69%;
                height: 100%;
            }
        }

    </style>
</head>
<body>
    <div id="description">
        <p>Here's some stuff and we'll add something about contributing</p>
    </div>
    <div id="content">
        <form id="choice">
            <label for="result_select">
            Select Results: 
            <select id="result_select">
                <option value="results">No Cheaters</option>
                <option selected value="all_results">All Results</option>
            </select>
        </label>
        </form>
        <div id="vis">
        </div>
    </div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="colorbrewer.js"></script>
    <script>

        // find the 
        function iqr(d) {
            var q1 = d3.quantile(d, 0.25);
            var q3 = d3.quantile(d, 0.75);
            var iqr = (q3 - q1) * 1.5;
            var i = -1;
            var j = d.length;
            while (d[++i] < (q1 - iqr));
            while (d[--j] > (q3 + iqr));
            return [i, j];
        }

        var svg;

        var width = document.getElementById("vis").clientWidth;
        var height = document.getElementById("vis").clientHeight;

        var padding_bottom = 150;
        var padding_left = 80;
        var padding_right = 40;
        var padding_top = 40;

        var y_scale = d3.scale.linear()
            .range([height-padding_bottom, padding_top]);

        var x_scale = d3.scale.ordinal()
            .rangeRoundBands([padding_left, width-padding_right], 0.5, 0.4);

        var colour_scale = d3.scale.quantile()
            .range(colorbrewer.Blues[9]);

        var x_axis = d3.svg.axis()
            .scale(x_scale)
            .orient("bottom");

        var y_axis = d3.svg.axis()
            .scale(y_scale)
            .orient("left")
            .tickFormat(d3.format(".2s"));

        var results;
        var keys;

        var init_plot = function() {
            svg = d3.select('#vis')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + (height-padding_bottom) + ")");

            svg.selectAll('.x.axis text')
                .style("text-anchor", "end")
                .attr("transform", "translate(-15,10)rotate(-90)");

            svg.append("g")
              .attr("class", "y axis")
              .attr("transform", "translate(" + (padding_left) + ", " + "0)")
            .append("text")
              .attr("transform", "translate(-45," + height/4 + ")rotate(-90)")
              .style("text-anchor", "end")
              .text("Mean score per game over 200 rounds repeated 50 times");
        }

        var load_results = function(results) {
            
            d3.csv(results + '.csv', function(error, data) {

                // extract the list of players
                keys = data.map(function(d) {
                    return d.player;
                });

                // coerce data into a proper format - array of numerical scores
                data.forEach(function(d){
                    var temp = d.scores.replace('[', '')
                    temp = temp.replace(']', '')
                    scores = temp.split(',')
                    d.scores = scores.map(function(s) { return +s/(200 * (keys.length-1)); });
                    d.scores = d.scores.sort();
                });

                results = data;

                var max = d3.max(results, function(d){ return d3.max(d.scores); });
                var min = d3.min(results, function(d){ return d3.min(d.scores); });
                var medians = [];
                results.forEach(function(d){ 
                    medians.push(d3.median(d.scores)); 
                });

                colour_scale.domain(medians);

                y_scale
                    .domain([min, max]);

                x_scale
                    .domain(keys);

                draw_plot(results);
            });
        }

        var draw_plot = function(results) {
        
            svg.selectAll('.box')
                .style("opacity", 0)
                .remove();

            var boxes = svg.selectAll('.box')
                .data(results);

            var box = boxes
                .enter()
                .append('g')
                .attr('class', function(d){ return "box " + d.player; });

            box
                .append('rect')
                .attr('class', 'quartiles')
                .attr('x', function(d) {
                    return x_scale(d.player)
                })
                .attr('width', x_scale.rangeBand())
                .attr('y', function(d){
                    var upper_quartile = d3.quantile(d.scores, 0.75);
                    return y_scale(upper_quartile);
                })
                .attr('height', function(d) {
                    var lower_quartile = d3.quantile(d.scores, 0.25);
                    var upper_quartile = d3.quantile(d.scores, 0.75);
                    return y_scale(lower_quartile)-y_scale(upper_quartile);
                })
                .attr("fill", function(d) {
                    return colour_scale(d3.median(d.scores));
                })
                .attr("stroke", "blue")
                .style('opacity', 0);
            
            box
                .append('path')
                .attr('class', 'median')
                .attr('d', function(d) {
                    var median = d3.median(d.scores);
                    var band_width = x_scale.rangeBand();
                    var x_start = x_scale(d.player);
                    var y = y_scale(median);
                    var path = "M " + x_start + " " + y + " L " + " " + (x_start+band_width) + " " + y;
                    return path;
                })
                .attr('stroke', 'red')
                .attr('stroke-width', '2')
                .style('opacity', 0);

            box
                .append('path')
                .attr('class', 'upper-whisker')
                .attr('d', function(d) {
                    var lower_quartile = d3.quantile(d.scores, 0.25);
                    var upper_quartile = d3.quantile(d.scores, 0.75);
                    var i = iqr(d.scores)
                    var reach = d.scores[i[1]];
                    var band_width = x_scale.rangeBand();
                    var x_start = x_scale(d.player);
                    var path = "M " + (x_start + (band_width/2)) + " " + y_scale(upper_quartile) + " L " + (x_start + (band_width/2)) + " " + y_scale(reach) + " " + (x_start + band_width) + " " + y_scale(reach) + " " + x_start + " " +  y_scale(reach);
                    return path;
                })
                .attr('stroke', 'black')
                .attr('fill', 'none')
                .style('opacity', 0);

            box
                .append('path')
                .attr('class', 'lower-whisker')
                .attr('stroke', 'black')
                .attr('fill', 'none')
                .attr('d', function(d) {
                    var lower_quartile = d3.quantile(d.scores, 0.25);
                    var upper_quartile = d3.quantile(d.scores, 0.75);
                    var i = iqr(d.scores)
                    var reach = d.scores[i[0]];
                    var band_width = x_scale.rangeBand();
                    var x_start = x_scale(d.player);
                    var path = "M " + (x_start + (band_width/2)) + " " + y_scale(lower_quartile) + " L " + (x_start + (band_width/2)) + " " + y_scale(reach) + " " + (x_start + band_width) + " " + y_scale(reach) + " " + x_start + " " +  y_scale(reach);
                    return path;
                })
                .style('opacity', 0);
            
            boxes.selectAll('.median')
                .transition()
                .duration(1000)
                .style('opacity', 1);

            boxes.selectAll('.quartiles')
                .transition()
                .duration(1000)
                .style('opacity', 1);

            boxes.selectAll('.upper-whisker')
                .transition()
                .duration(1000)
                .style('opacity', 1);

            boxes.selectAll('.lower-whisker')
                .transition()
                .duration(1000)                
                .style('opacity', 1);

            boxes
                .exit()
                .transition()
                .duration(1000)
                .style('opacity', 0)
                .remove();
              

            svg.select('.x.axis')
                .transition()
                .duration(1000)
                .call(x_axis);

            svg.select('.x.axis')
                .selectAll('text')
                .attr('transform', 'translate(-10, 20)rotate(-90)')
                .style('text-anchor', 'end');

            svg.select('.y.axis')
                .transition()
                .duration(1000)
                .call(y_axis);
        }

        d3.select('#result_select')
            .on('change', function() {
                var selected = this.options[this.selectedIndex].value;
                load_results(selected);
            })
        init_plot();
        load_results('all_results');

    </script>
</body>
</html>