<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Axelrod</title>
    <style>
        html, body, #vis{
            padding: 0px;
            margin: 0px;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="vis"></div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script>
        var width = document.getElementById("vis").clientWidth;
        var height = document.getElementById("vis").clientHeight;

        console.log(width);
        console.log(height);

        d3.csv('results.csv', function(error, data){

            var svg = d3.select('#vis')
                        .append('svg')
                        .attr('width', width)
                        .attr('height', height);

            // coerce data into a proper format - array of numerical scores
            data.forEach(function(d){
                var temp = d.scores.replace('[', '')
                temp = temp.replace(']', ',')
                scores = temp.split(',')
                d.scores = scores.map(function(s) { return +s; });
                d.scores.pop();
                d.scores = d.scores.sort();
                //d.scores = d.scores.filter(function(s){ return s !== 0; });
            })

            var max = d3.max(data, function(d){ return d3.max(d.scores); });
            var min = d3.min(data, function(d){ return d3.min(d.scores); });

            console.log(max);
            console.log(min);

            var keys = data.map(function(d) {
                return d.player;
            });
            console.log(keys)

            var y_scale = d3.scale.linear()
                            .range([height, 0])
                            .domain([min, max]);

            var x_scale = d3.scale.ordinal()
                            .rangeRoundBands([0, width], 0.1, 0.2)
                            .domain(keys);

            console.log(data);

            var boxes = svg.selectAll('.box')
                .data(data)
                .enter()
                .append('g')
                .attr('class', 'box')
                .attr('data-median', function(d){ return d3.median(d.scores); })
                .attr('data-first-quartile', function(d){ return d3.quantile(d.scores, 0.25); })
                .attr('data-third-quartile', function(d){ return d3.quantile(d.scores, 0.75); })

            boxes
                .append('path')
                .attr('class', 'median')
                .attr('d', function(d) {
                    var median = d3.median(d.scores);
                    var band_width = x_scale.rangeBand();
                    var x_start = x_scale(d.player);
                    var y = y_scale(median);
                    var path = "M " + x_start + " " + y + " L " + " " + (x_start+band_width) + " " + y;
                    return path;
                })
                .attr('stroke', 'black')
                .attr('stroke-width', '2')

            boxes
                .append('rect')
                .attr('class', 'lower_quartile')
                .attr('x', function(d) {
                    return x_scale(d.player)
                })
                .attr('width', x_scale.rangeBand())
                .attr('y', function(d){
                    var median = d3.median(d.scores);
                    return y_scale(median);
                })
                .attr('height', function(d) {
                    var lower_quartile = d3.quantile(d.scores, 0.25);
                    var median = d3.median(d.scores);
                    return y_scale(lower_quartile)-y_scale(median);
                })
                .attr("fill", "none")
                .attr("stroke", "black")

            boxes
                .append('rect')
                .attr('class', 'upper_quartile')
                .attr('x', function(d) {
                    return x_scale(d.player)
                })
                .attr('width', x_scale.rangeBand())
                .attr('y', function(d){
                    var upper_quartile = d3.quantile(d.scores, 0.75);
                    return y_scale(upper_quartile);
                })
                .attr('height', function(d) {
                    var upper_quartile = d3.quantile(d.scores, 0.75);
                    var median = d3.median(d.scores);
                    return y_scale(median)-y_scale(upper_quartile);
                })
                .attr("fill", "none")
                .attr("stroke", "black")              
        });

        // Returns a function to compute the interquartile range.
        function iqr(k) {
          return function(d, i) {
            var q1 = d.quartiles[0],
                q3 = d.quartiles[2],
                iqr = (q3 - q1) * k,
                i = -1,
                j = d.length;
            while (d[++i] < q1 - iqr);
            while (d[--j] > q3 + iqr);
            return [i, j];
          };
        }
    </script>
</body>
</html>